<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭成就系统 - 萌芽AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="mengya-common.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
        }
        .achievement-container {
            background: white;
            border-radius: 25px 25px 0 0;
            min-height: calc(100vh - 120px);
            position: relative;
        }
        .achievement-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        .achievement-card.unlocked {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            border: 2px solid #f59e0b;
            box-shadow: 0 12px 40px rgba(245, 158, 11, 0.3);
        }
        .achievement-card.locked {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            opacity: 0.7;
        }
        .achievement-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.15);
        }
        .achievement-badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 16px;
            position: relative;
        }
        .achievement-badge.gold {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            animation: goldShine 3s ease-in-out infinite;
        }
        .achievement-badge.silver {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            color: white;
        }
        .achievement-badge.bronze {
            background: linear-gradient(135deg, #d97706, #92400e);
            color: white;
        }
        .achievement-badge.locked {
            background: #e5e7eb;
            color: #9ca3af;
        }
        @keyframes goldShine {
            0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); }
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            position: relative;
            margin: 0 auto;
        }
        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }
        .progress-ring .bg {
            stroke: #e5e7eb;
        }
        .progress-ring .progress {
            stroke: #fbbf24;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease-in-out;
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .family-level {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            margin: 16px 0;
        }
        .achievement-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        .celebration-animation {
            animation: celebration 2s ease-in-out;
        }
        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(2deg); }
            75% { transform: scale(1.05) rotate(-2deg); }
        }
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fbbf24;
            border-radius: 50%;
            animation: sparkle 2s ease-in-out infinite;
        }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部导航栏 -->
    <div class="gradient-bg px-6 py-4">
        <div class="flex items-center justify-between">
            <button onclick="navigateBack()" class="text-white text-xl">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="text-center flex-1">
                <h1 class="text-white text-lg font-bold">家庭成就系统</h1>
                <p class="text-white text-sm opacity-90">记录你们的每一份成长</p>
            </div>
            <button onclick="shareAchievements()" class="text-white text-xl">
                <i class="fas fa-share-alt"></i>
            </button>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="achievement-container">
        <!-- 家庭等级显示 -->
        <div class="px-6 py-4">
            <div class="family-level">
                <div class="text-center">
                    <div class="text-4xl mb-2">🏆</div>
                    <h2 class="text-xl font-bold mb-2" id="familyLevel">学习新星家庭 Lv.5</h2>
                    <p class="text-sm opacity-90 mb-4">距离下一级还需要 <span id="pointsToNext">350</span> 积分</p>
                    
                    <!-- 经验进度条 -->
                    <div class="progress-ring">
                        <svg>
                            <circle class="bg" cx="60" cy="60" r="52"></circle>
                            <circle class="progress" cx="60" cy="60" r="52" 
                                    stroke-dasharray="327" 
                                    stroke-dashoffset="98"
                                    id="levelProgress"></circle>
                        </svg>
                        <div class="progress-text">
                            <div class="text-2xl font-bold" id="currentExp">1650</div>
                            <div class="text-xs opacity-75">/ 2000</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计概览 -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
                成就统计
            </h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="text-3xl font-bold text-blue-600" id="totalAchievements">12</div>
                    <div class="text-sm text-gray-600 mt-1">已解锁成就</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-green-600" id="familyPoints">1650</div>
                    <div class="text-sm text-gray-600 mt-1">家庭积分</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-purple-600" id="collaborativeDays">15</div>
                    <div class="text-sm text-gray-600 mt-1">协作天数</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-orange-600" id="familyRank">68</div>
                    <div class="text-sm text-gray-600 mt-1">全球排名</div>
                </div>
            </div>
        </div>

        <!-- 最新成就 -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-star mr-2 text-yellow-500"></i>
                最新获得
            </h3>
            <div id="latestAchievements" class="space-y-4">
                <!-- 最新成就将动态生成 -->
            </div>
        </div>

        <!-- 成就画廊 -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-trophy mr-2 text-yellow-600"></i>
                成就画廊
            </h3>
            <div class="achievement-gallery" id="achievementGallery">
                <!-- 成就卡片将动态生成 -->
            </div>
        </div>

        <!-- 挑战任务 -->
        <div class="px-6 py-4 pb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-flag mr-2 text-red-500"></i>
                挑战任务
            </h3>
            <div id="challengeTasks" class="space-y-4">
                <!-- 挑战任务将动态生成 -->
            </div>
        </div>
    </div>

    <!-- 成就详情模态框 -->
    <div id="achievementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-6 m-6 max-w-md w-full">
            <div class="text-center">
                <div id="modalBadge" class="achievement-badge gold mx-auto mb-4">
                    <i class="fas fa-trophy"></i>
                </div>
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-2">成就标题</h3>
                <p id="modalDescription" class="text-gray-600 mb-4">成就描述</p>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="text-sm text-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <span>获得时间:</span>
                            <span id="modalDate">2024-01-15</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span>奖励积分:</span>
                            <span id="modalPoints" class="text-yellow-600 font-semibold">+100</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>参与成员:</span>
                            <span id="modalMembers">全家</span>
                        </div>
                    </div>
                </div>
                <button onclick="closeAchievementModal()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <script>
        let familyData = {};
        let achievements = [];
        let challengeTasks = [];

        // 页面初始化
        MengyaUtils.Lifecycle.onInit(async () => {
            await initializeAchievementSystem();
            loadFamilyLevel();
            loadAchievements();
            loadChallenges();
            updateStatistics();
        });

        // 初始化成就系统
        async function initializeAchievementSystem() {
            try {
                // 加载家庭数据
                familyData = await MengyaUtils.Data.getData('family') || {};
                
                // 初始化成就数据
                achievements = await MengyaUtils.Data.getData('family.achievements') || generateDefaultAchievements();
                challengeTasks = await MengyaUtils.Data.getData('family.challenges') || generateDefaultChallenges();
                
                // 家庭成就系统初始化完成
            } catch (error) {
                console.error('成就系统初始化失败:', error);
                // 使用默认数据
                achievements = generateDefaultAchievements();
                challengeTasks = generateDefaultChallenges();
            }
        }

        // 生成默认成就数据
        function generateDefaultAchievements() {
            return [
                {
                    id: 'first_collaboration',
                    title: '初次协作',
                    description: '完成第一次亲子协作学习活动',
                    icon: 'fas fa-handshake',
                    type: 'gold',
                    unlocked: true,
                    unlockedDate: new Date('2024-01-15'),
                    points: 100,
                    participants: ['爸爸', '小明']
                },
                {
                    id: 'story_master',
                    title: '故事大师',
                    description: '协作创作10个完整故事',
                    icon: 'fas fa-book',
                    type: 'silver',
                    unlocked: true,
                    unlockedDate: new Date('2024-01-20'),
                    points: 150,
                    participants: ['全家']
                },
                {
                    id: 'creative_genius',
                    title: '创意天才',
                    description: '在创意活动中获得满分评价',
                    icon: 'fas fa-lightbulb',
                    type: 'bronze',
                    unlocked: true,
                    unlockedDate: new Date('2024-01-22'),
                    points: 120,
                    participants: ['小明', '妈妈']
                },
                {
                    id: 'week_streak',
                    title: '连续学霸',
                    description: '连续7天进行家庭学习活动',
                    icon: 'fas fa-fire',
                    type: 'gold',
                    unlocked: false,
                    progress: 5,
                    total: 7,
                    points: 200
                },
                {
                    id: 'puzzle_solver',
                    title: '解谜高手',
                    description: '成功解决20个智力拼图',
                    icon: 'fas fa-puzzle-piece',
                    type: 'silver',
                    unlocked: false,
                    progress: 12,
                    total: 20,
                    points: 180
                },
                {
                    id: 'family_bond',
                    title: '家庭纽带',
                    description: '累计家庭互动时间达到50小时',
                    icon: 'fas fa-heart',
                    type: 'gold',
                    unlocked: false,
                    progress: 32,
                    total: 50,
                    points: 300
                }
            ];
        }

        // 生成默认挑战数据
        function generateDefaultChallenges() {
            return [
                {
                    id: 'daily_story',
                    title: '每日故事挑战',
                    description: '连续7天每天创作一个故事',
                    progress: 3,
                    total: 7,
                    reward: '故事大师徽章',
                    points: 150,
                    deadline: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 'math_marathon',
                    title: '数学马拉松',
                    description: '完成100道数学题目',
                    progress: 45,
                    total: 100,
                    reward: '计算小能手称号',
                    points: 200,
                    deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 'art_gallery',
                    title: '家庭画廊',
                    description: '创作15幅协作画作',
                    progress: 8,
                    total: 15,
                    reward: '艺术家庭认证',
                    points: 180,
                    deadline: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000)
                }
            ];
        }

        // 加载家庭等级
        function loadFamilyLevel() {
            const level = calculateFamilyLevel();
            const currentExp = familyData.totalPoints || 1650;
            const nextLevelExp = level * 400; // 每级需要更多经验
            const expForCurrentLevel = (level - 1) * 400;
            const expProgress = currentExp - expForCurrentLevel;
            const expNeeded = nextLevelExp - expForCurrentLevel;
            
            document.getElementById('familyLevel').textContent = `学习新星家庭 Lv.${level}`;
            document.getElementById('pointsToNext').textContent = nextLevelExp - currentExp;
            document.getElementById('currentExp').textContent = currentExp;
            
            // 更新进度环
            const progressPercentage = (expProgress / expNeeded) * 100;
            const circumference = 2 * Math.PI * 52;
            const offset = circumference - (progressPercentage / 100) * circumference;
            document.getElementById('levelProgress').style.strokeDashoffset = offset;
        }

        // 计算家庭等级
        function calculateFamilyLevel() {
            const totalPoints = familyData.totalPoints || 1650;
            return Math.floor(totalPoints / 400) + 1;
        }

        // 加载成就
        function loadAchievements() {
            loadLatestAchievements();
            loadAchievementGallery();
        }

        // 加载最新成就
        function loadLatestAchievements() {
            const latestAchievements = achievements
                .filter(a => a.unlocked)
                .sort((a, b) => new Date(b.unlockedDate) - new Date(a.unlockedDate))
                .slice(0, 3);

            const container = document.getElementById('latestAchievements');
            
            if (latestAchievements.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-3xl mb-2"></i>
                        <p>开始家庭学习活动来获得第一个成就吧！</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = latestAchievements.map(achievement => `
                <div class="achievement-card unlocked celebration-animation" onclick="showAchievementDetail('${achievement.id}')">
                    <div class="flex items-center space-x-4">
                        <div class="achievement-badge ${achievement.type}">
                            <i class="${achievement.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-lg">${achievement.title}</h4>
                            <p class="text-gray-600 text-sm mb-2">${achievement.description}</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-calendar mr-1"></i>${formatDate(achievement.unlockedDate)}</span>
                                <span><i class="fas fa-coins mr-1"></i>+${achievement.points}</span>
                                <span><i class="fas fa-users mr-1"></i>${achievement.participants.join(', ')}</span>
                            </div>
                        </div>
                        <div class="text-yellow-500 text-2xl">
                            <i class="fas fa-medal"></i>
                        </div>
                    </div>
                    <div class="sparkle" style="top: 20px; left: 20px; animation-delay: 0s;"></div>
                    <div class="sparkle" style="top: 30px; right: 30px; animation-delay: 0.5s;"></div>
                    <div class="sparkle" style="bottom: 20px; left: 40px; animation-delay: 1s;"></div>
                </div>
            `).join('');
        }

        // 加载成就画廊
        function loadAchievementGallery() {
            const container = document.getElementById('achievementGallery');
            
            container.innerHTML = achievements.map(achievement => {
                const isUnlocked = achievement.unlocked;
                const progressHtml = !isUnlocked && achievement.progress !== undefined ? 
                    `<div class="mt-3">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>进度</span>
                            <span>${achievement.progress}/${achievement.total}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" 
                                 style="width: ${(achievement.progress / achievement.total) * 100}%"></div>
                        </div>
                    </div>` : '';

                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" 
                         onclick="showAchievementDetail('${achievement.id}')">
                        <div class="text-center">
                            <div class="achievement-badge ${isUnlocked ? achievement.type : 'locked'}">
                                <i class="${achievement.icon}"></i>
                            </div>
                            <h4 class="font-bold text-lg mb-2 ${isUnlocked ? 'text-gray-800' : 'text-gray-500'}">${achievement.title}</h4>
                            <p class="text-sm mb-3 ${isUnlocked ? 'text-gray-600' : 'text-gray-400'}">${achievement.description}</p>
                            <div class="text-xs ${isUnlocked ? 'text-yellow-600' : 'text-gray-400'} font-semibold">
                                <i class="fas fa-coins mr-1"></i>+${achievement.points} 积分
                            </div>
                            ${progressHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 加载挑战任务
        function loadChallenges() {
            const container = document.getElementById('challengeTasks');
            
            container.innerHTML = challengeTasks.map(challenge => {
                const progressPercentage = (challenge.progress / challenge.total) * 100;
                const daysLeft = Math.ceil((challenge.deadline - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="achievement-card">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-red-400 to-pink-400 flex items-center justify-center text-white">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-gray-800">${challenge.title}</h4>
                                    <span class="text-xs text-red-500 bg-red-100 px-2 py-1 rounded">
                                        ${daysLeft}天后结束
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">${challenge.description}</p>
                                <div class="mb-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>进度</span>
                                        <span>${challenge.progress}/${challenge.total}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-gradient-to-r from-red-400 to-pink-400 h-3 rounded-full transition-all duration-500" 
                                             style="width: ${progressPercentage}%"></div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-green-600 font-semibold">${challenge.reward}</span>
                                    <span class="text-yellow-600 font-semibold">+${challenge.points} 积分</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 更新统计数据
        function updateStatistics() {
            const unlockedCount = achievements.filter(a => a.unlocked).length;
            const totalPoints = familyData.totalPoints || 1650;
            const collaborativeDays = familyData.collaborativeDays || 15;
            const familyRank = familyData.rank || 68;

            document.getElementById('totalAchievements').textContent = unlockedCount;
            document.getElementById('familyPoints').textContent = totalPoints;
            document.getElementById('collaborativeDays').textContent = collaborativeDays;
            document.getElementById('familyRank').textContent = familyRank;

            // 添加数字动画
            animateCounters();
        }

        // 显示成就详情
        function showAchievementDetail(achievementId) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement) return;

            if (!achievement.unlocked) {
                MengyaUtils.Notification.info(`还未解锁此成就。进度: ${achievement.progress || 0}/${achievement.total || 1}`);
                return;
            }

            // 更新模态框内容
            document.getElementById('modalBadge').className = `achievement-badge ${achievement.type}`;
            document.getElementById('modalBadge').innerHTML = `<i class="${achievement.icon}"></i>`;
            document.getElementById('modalTitle').textContent = achievement.title;
            document.getElementById('modalDescription').textContent = achievement.description;
            document.getElementById('modalDate').textContent = formatDate(achievement.unlockedDate);
            document.getElementById('modalPoints').textContent = `+${achievement.points}`;
            document.getElementById('modalMembers').textContent = achievement.participants.join(', ');

            // 显示模态框
            document.getElementById('achievementModal').classList.remove('hidden');
            document.getElementById('achievementModal').classList.add('flex');
        }

        // 关闭成就详情模态框
        function closeAchievementModal() {
            document.getElementById('achievementModal').classList.add('hidden');
            document.getElementById('achievementModal').classList.remove('flex');
        }

        // 分享成就
        async function shareAchievements() {
            const shareModal = document.createElement('div');
            shareModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            shareModal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 m-6 max-w-md w-full">
                    <div class="text-center">
                        <div class="text-4xl mb-4">🎉</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">分享家庭成就</h3>
                        <p class="text-gray-600 mb-6">选择分享方式</p>
                        
                        <div class="space-y-3 mb-6">
                            <button onclick="shareToSocial()" class="w-full p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-share-alt text-blue-500"></i>
                                    <div class="text-left">
                                        <div class="font-semibold">分享到社交平台</div>
                                        <div class="text-sm text-gray-600">让更多人看到我们的成就</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="generateAchievementReport()" class="w-full p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-file-alt text-green-500"></i>
                                    <div class="text-left">
                                        <div class="font-semibold">生成成就报告</div>
                                        <div class="text-sm text-gray-600">创建详细的成就总结</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="createAchievementVideo()" class="w-full p-4 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-video text-purple-500"></i>
                                    <div class="text-left">
                                        <div class="font-semibold">制作成就视频</div>
                                        <div class="text-sm text-gray-600">生成精美的成就展示视频</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        
                        <button onclick="closeShareModal()" class="w-full py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold">
                            取消
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(shareModal);
            window.currentShareModal = shareModal;
        }

        // 分享到社交平台
        async function shareToSocial() {
            const unlockedCount = achievements.filter(a => a.unlocked).length;
            const totalPoints = familyData.totalPoints || 1650;
            
            const shareText = `🏆 我们家在萌芽AI已经获得了${unlockedCount}个成就，累计${totalPoints}积分！一起来体验家庭协作学习的乐趣吧！`;
            
            closeShareModal();
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: '家庭学习成就',
                        text: shareText,
                        url: window.location.href
                    });
                } catch (error) {
                    // 复制到剪贴板作为后备
                    await navigator.clipboard.writeText(shareText);
                    MengyaUtils.Notification.success('成就信息已复制到剪贴板！');
                }
            } else {
                // 复制到剪贴板
                await navigator.clipboard.writeText(shareText);
                MengyaUtils.Notification.success('成就信息已复制到剪贴板！');
            }
        }

        // 生成成就报告
        function generateAchievementReport() {
            closeShareModal();
            
            // 显示生成中的动画
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 relative">
                        <div class="absolute inset-0 rounded-full border-4 border-blue-200"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-2xl">
                            📊
                        </div>
                    </div>
                    <p class="text-gray-600">正在生成成就报告...</p>
                </div>
            `;
            
            document.body.appendChild(loadingModal);
            
            // 模拟生成过程
            setTimeout(() => {
                document.body.removeChild(loadingModal);
                
                // 创建报告内容
                const unlockedCount = achievements.filter(a => a.unlocked).length;
                const totalPoints = familyData.totalPoints || 1650;
                const reportData = {
                    totalAchievements: unlockedCount,
                    totalPoints: totalPoints,
                    categories: getCategoryStats(),
                    recentAchievements: achievements.filter(a => a.unlocked).slice(0, 5),
                    timestamp: new Date().toISOString()
                };
                
                // 下载报告
                downloadReport(reportData);
                MengyaUtils.Notification.success('📊 成就报告已生成并下载！');
            }, 3000);
        }

        // 获取分类统计
        function getCategoryStats() {
            const categories = {};
            achievements.filter(a => a.unlocked).forEach(achievement => {
                const category = achievement.type;
                if (!categories[category]) {
                    categories[category] = { count: 0, points: 0 };
                }
                categories[category].count++;
                categories[category].points += achievement.points;
            });
            return categories;
        }

        // 下载报告
        function downloadReport(data) {
            const reportContent = `
# 家庭学习成就报告

## 总体概况
- 总成就数: ${data.totalAchievements}
- 总积分: ${data.totalPoints}
- 生成时间: ${new Date(data.timestamp).toLocaleString('zh-CN')}

## 分类统计
${Object.entries(data.categories).map(([category, stats]) => 
    `- ${getCategoryDisplayName(category)}: ${stats.count}个成就, ${stats.points}积分`
).join('\n')}

## 最近获得的成就
${data.recentAchievements.map(achievement => 
    `- ${achievement.title}: ${achievement.description} (+${achievement.points}积分)`
).join('\n')}
            `;
            
            const blob = new Blob([reportContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family-achievements-${new Date().toISOString().split('T')[0]}.md`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 获取分类显示名称
        function getCategoryDisplayName(category) {
            const names = {
                learning: '学习成就',
                collaboration: '协作成就',
                creativity: '创意成就',
                milestone: '里程碑',
                special: '特殊成就'
            };
            return names[category] || category;
        }

        // 制作成就视频
        function createAchievementVideo() {
            closeShareModal();
            
            // 显示制作中的动画
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 relative">
                        <div class="absolute inset-0 rounded-full border-4 border-purple-200"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-purple-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-2xl">
                            🎬
                        </div>
                    </div>
                    <p class="text-gray-600 mb-2">正在制作成就视频...</p>
                    <div class="text-sm text-gray-500">
                        <div id="videoProgress">收集成就数据...</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loadingModal);
            
            // 模拟视频制作步骤
            const steps = [
                "收集成就数据...",
                "分析学习历程...",
                "生成视觉效果...",
                "添加背景音乐...",
                "渲染最终视频..."
            ];
            
            let stepIndex = 0;
            const stepInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    document.getElementById('videoProgress').textContent = steps[stepIndex];
                    stepIndex++;
                } else {
                    clearInterval(stepInterval);
                    document.body.removeChild(loadingModal);
                    MengyaUtils.Notification.success('🎬 成就视频制作完成！已保存到相册。');
                }
            }, 1000);
        }

        // 关闭分享模态框
        function closeShareModal() {
            if (window.currentShareModal) {
                document.body.removeChild(window.currentShareModal);
                window.currentShareModal = null;
            }
        }

        // 解锁新成就（供其他页面调用）
        async function unlockAchievement(achievementId, participants = []) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement || achievement.unlocked) return;

            achievement.unlocked = true;
            achievement.unlockedDate = new Date();
            achievement.participants = participants;

            // 保存数据
            await MengyaUtils.Data.setData('family.achievements', achievements);
            
            // 更新家庭积分
            familyData.totalPoints = (familyData.totalPoints || 0) + achievement.points;
            await MengyaUtils.Data.setData('family', familyData);

            // 显示庆祝动画
            showAchievementCelebration(achievement);
            
            // 重新加载显示
            loadAchievements();
            updateStatistics();
            loadFamilyLevel();
        }

        // 显示成就庆祝动画
        function showAchievementCelebration(achievement) {
            // 创建庆祝弹窗
            const celebration = document.createElement('div');
            celebration.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            celebration.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center celebration-animation">
                    <div class="text-6xl mb-4">🎉</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">恭喜解锁新成就！</h2>
                    <div class="achievement-badge ${achievement.type} mx-auto mb-4">
                        <i class="${achievement.icon}"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${achievement.title}</h3>
                    <p class="text-gray-600 mb-4">${achievement.description}</p>
                    <div class="text-yellow-600 font-bold text-lg">+${achievement.points} 积分</div>
                </div>
            `;
            
            document.body.appendChild(celebration);
            
            // 3秒后自动关闭
            setTimeout(() => {
                document.body.removeChild(celebration);
            }, 3000);
            
            // 播放庆祝音效（如果支持）
            try {
                new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+Dyvmg').play();
            } catch (error) {
                // 忽略音效播放错误
            }
        }

        // 更新挑战进度
        async function updateChallengeProgress(challengeId, increment = 1) {
            const challenge = challengeTasks.find(c => c.id === challengeId);
            if (!challenge) return;

            challenge.progress = Math.min(challenge.progress + increment, challenge.total);
            
            // 保存数据
            await MengyaUtils.Data.setData('family.challenges', challengeTasks);
            
            // 检查是否完成挑战
            if (challenge.progress >= challenge.total) {
                // 完成挑战，给予奖励
                familyData.totalPoints = (familyData.totalPoints || 0) + challenge.points;
                await MengyaUtils.Data.setData('family', familyData);
                
                MengyaUtils.Notification.success(`🎊 完成挑战：${challenge.title}！获得 ${challenge.points} 积分！`);
                
                // 移除已完成的挑战
                challengeTasks = challengeTasks.filter(c => c.id !== challengeId);
                await MengyaUtils.Data.setData('family.challenges', challengeTasks);
                
                // 重新加载显示
                loadChallenges();
                updateStatistics();
                loadFamilyLevel();
            } else {
                // 重新加载挑战显示
                loadChallenges();
            }
        }

        // 数字动画
        function animateCounters() {
            const counters = document.querySelectorAll('#totalAchievements, #familyPoints, #collaborativeDays, #familyRank');
            counters.forEach(counter => {
                const target = parseInt(counter.textContent);
                let current = 0;
                const increment = target / 30;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    counter.textContent = Math.floor(current);
                }, 50);
            });
        }

        // 格式化日期
        function formatDate(date) {
            return new Date(date).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // 返回上一页
        function navigateBack() {
            MengyaUtils.Navigation.smartBack();
        }

        // 导出函数供其他页面使用
        window.FamilyAchievements = {
            unlockAchievement,
            updateChallengeProgress
        };
    </script>
</body>
</html> 