<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æˆå°±ç³»ç»Ÿ - èŒèŠ½AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="mengya-common.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
        }
        .achievement-container {
            background: white;
            border-radius: 25px 25px 0 0;
            min-height: calc(100vh - 120px);
            position: relative;
        }
        .achievement-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        .achievement-card.unlocked {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            border: 2px solid #f59e0b;
            box-shadow: 0 12px 40px rgba(245, 158, 11, 0.3);
        }
        .achievement-card.locked {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            opacity: 0.7;
        }
        .achievement-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.15);
        }
        .achievement-badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 16px;
            position: relative;
        }
        .achievement-badge.gold {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            animation: goldShine 3s ease-in-out infinite;
        }
        .achievement-badge.silver {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            color: white;
        }
        .achievement-badge.bronze {
            background: linear-gradient(135deg, #d97706, #92400e);
            color: white;
        }
        .achievement-badge.locked {
            background: #e5e7eb;
            color: #9ca3af;
        }
        @keyframes goldShine {
            0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); }
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            position: relative;
            margin: 0 auto;
        }
        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }
        .progress-ring .bg {
            stroke: #e5e7eb;
        }
        .progress-ring .progress {
            stroke: #fbbf24;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease-in-out;
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .family-level {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            margin: 16px 0;
        }
        .achievement-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        .celebration-animation {
            animation: celebration 2s ease-in-out;
        }
        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(2deg); }
            75% { transform: scale(1.05) rotate(-2deg); }
        }
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fbbf24;
            border-radius: 50%;
            animation: sparkle 2s ease-in-out infinite;
        }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="gradient-bg px-6 py-4">
        <div class="flex items-center justify-between">
            <button onclick="navigateBack()" class="text-white text-xl">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="text-center flex-1">
                <h1 class="text-white text-lg font-bold">å®¶åº­æˆå°±ç³»ç»Ÿ</h1>
                <p class="text-white text-sm opacity-90">è®°å½•ä½ ä»¬çš„æ¯ä¸€ä»½æˆé•¿</p>
            </div>
            <button onclick="shareAchievements()" class="text-white text-xl">
                <i class="fas fa-share-alt"></i>
            </button>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="achievement-container">
        <!-- å®¶åº­ç­‰çº§æ˜¾ç¤º -->
        <div class="px-6 py-4">
            <div class="family-level">
                <div class="text-center">
                    <div class="text-4xl mb-2">ğŸ†</div>
                    <h2 class="text-xl font-bold mb-2" id="familyLevel">å­¦ä¹ æ–°æ˜Ÿå®¶åº­ Lv.5</h2>
                    <p class="text-sm opacity-90 mb-4">è·ç¦»ä¸‹ä¸€çº§è¿˜éœ€è¦ <span id="pointsToNext">350</span> ç§¯åˆ†</p>
                    
                    <!-- ç»éªŒè¿›åº¦æ¡ -->
                    <div class="progress-ring">
                        <svg>
                            <circle class="bg" cx="60" cy="60" r="52"></circle>
                            <circle class="progress" cx="60" cy="60" r="52" 
                                    stroke-dasharray="327" 
                                    stroke-dashoffset="98"
                                    id="levelProgress"></circle>
                        </svg>
                        <div class="progress-text">
                            <div class="text-2xl font-bold" id="currentExp">1650</div>
                            <div class="text-xs opacity-75">/ 2000</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
                æˆå°±ç»Ÿè®¡
            </h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="text-3xl font-bold text-blue-600" id="totalAchievements">12</div>
                    <div class="text-sm text-gray-600 mt-1">å·²è§£é”æˆå°±</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-green-600" id="familyPoints">1650</div>
                    <div class="text-sm text-gray-600 mt-1">å®¶åº­ç§¯åˆ†</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-purple-600" id="collaborativeDays">15</div>
                    <div class="text-sm text-gray-600 mt-1">åä½œå¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-orange-600" id="familyRank">68</div>
                    <div class="text-sm text-gray-600 mt-1">å…¨çƒæ’å</div>
                </div>
            </div>
        </div>

        <!-- æœ€æ–°æˆå°± -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-star mr-2 text-yellow-500"></i>
                æœ€æ–°è·å¾—
            </h3>
            <div id="latestAchievements" class="space-y-4">
                <!-- æœ€æ–°æˆå°±å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æˆå°±ç”»å»Š -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-trophy mr-2 text-yellow-600"></i>
                æˆå°±ç”»å»Š
            </h3>
            <div class="achievement-gallery" id="achievementGallery">
                <!-- æˆå°±å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æŒ‘æˆ˜ä»»åŠ¡ -->
        <div class="px-6 py-4 pb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-flag mr-2 text-red-500"></i>
                æŒ‘æˆ˜ä»»åŠ¡
            </h3>
            <div id="challengeTasks" class="space-y-4">
                <!-- æŒ‘æˆ˜ä»»åŠ¡å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æˆå°±è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="achievementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-6 m-6 max-w-md w-full">
            <div class="text-center">
                <div id="modalBadge" class="achievement-badge gold mx-auto mb-4">
                    <i class="fas fa-trophy"></i>
                </div>
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-2">æˆå°±æ ‡é¢˜</h3>
                <p id="modalDescription" class="text-gray-600 mb-4">æˆå°±æè¿°</p>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="text-sm text-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <span>è·å¾—æ—¶é—´:</span>
                            <span id="modalDate">2024-01-15</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span>å¥–åŠ±ç§¯åˆ†:</span>
                            <span id="modalPoints" class="text-yellow-600 font-semibold">+100</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>å‚ä¸æˆå‘˜:</span>
                            <span id="modalMembers">å…¨å®¶</span>
                        </div>
                    </div>
                </div>
                <button onclick="closeAchievementModal()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        let familyData = {};
        let achievements = [];
        let challengeTasks = [];

        // é¡µé¢åˆå§‹åŒ–
        MengyaUtils.Lifecycle.onInit(async () => {
            await initializeAchievementSystem();
            loadFamilyLevel();
            loadAchievements();
            loadChallenges();
            updateStatistics();
        });

        // åˆå§‹åŒ–æˆå°±ç³»ç»Ÿ
        async function initializeAchievementSystem() {
            try {
                // åŠ è½½å®¶åº­æ•°æ®
                familyData = await MengyaUtils.Data.getData('family') || {};
                
                // åˆå§‹åŒ–æˆå°±æ•°æ®
                achievements = await MengyaUtils.Data.getData('family.achievements') || generateDefaultAchievements();
                challengeTasks = await MengyaUtils.Data.getData('family.challenges') || generateDefaultChallenges();
                
                // å®¶åº­æˆå°±ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
            } catch (error) {
                console.error('æˆå°±ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                achievements = generateDefaultAchievements();
                challengeTasks = generateDefaultChallenges();
            }
        }

        // ç”Ÿæˆé»˜è®¤æˆå°±æ•°æ®
        function generateDefaultAchievements() {
            return [
                {
                    id: 'first_collaboration',
                    title: 'åˆæ¬¡åä½œ',
                    description: 'å®Œæˆç¬¬ä¸€æ¬¡äº²å­åä½œå­¦ä¹ æ´»åŠ¨',
                    icon: 'fas fa-handshake',
                    type: 'gold',
                    unlocked: true,
                    unlockedDate: new Date('2024-01-15'),
                    points: 100,
                    participants: ['çˆ¸çˆ¸', 'å°æ˜']
                },
                {
                    id: 'story_master',
                    title: 'æ•…äº‹å¤§å¸ˆ',
                    description: 'åä½œåˆ›ä½œ10ä¸ªå®Œæ•´æ•…äº‹',
                    icon: 'fas fa-book',
                    type: 'silver',
                    unlocked: true,
                    unlockedDate: new Date('2024-01-20'),
                    points: 150,
                    participants: ['å…¨å®¶']
                },
                {
                    id: 'creative_genius',
                    title: 'åˆ›æ„å¤©æ‰',
                    description: 'åœ¨åˆ›æ„æ´»åŠ¨ä¸­è·å¾—æ»¡åˆ†è¯„ä»·',
                    icon: 'fas fa-lightbulb',
                    type: 'bronze',
                    unlocked: true,
                    unlockedDate: new Date('2024-01-22'),
                    points: 120,
                    participants: ['å°æ˜', 'å¦ˆå¦ˆ']
                },
                {
                    id: 'week_streak',
                    title: 'è¿ç»­å­¦éœ¸',
                    description: 'è¿ç»­7å¤©è¿›è¡Œå®¶åº­å­¦ä¹ æ´»åŠ¨',
                    icon: 'fas fa-fire',
                    type: 'gold',
                    unlocked: false,
                    progress: 5,
                    total: 7,
                    points: 200
                },
                {
                    id: 'puzzle_solver',
                    title: 'è§£è°œé«˜æ‰‹',
                    description: 'æˆåŠŸè§£å†³20ä¸ªæ™ºåŠ›æ‹¼å›¾',
                    icon: 'fas fa-puzzle-piece',
                    type: 'silver',
                    unlocked: false,
                    progress: 12,
                    total: 20,
                    points: 180
                },
                {
                    id: 'family_bond',
                    title: 'å®¶åº­çº½å¸¦',
                    description: 'ç´¯è®¡å®¶åº­äº’åŠ¨æ—¶é—´è¾¾åˆ°50å°æ—¶',
                    icon: 'fas fa-heart',
                    type: 'gold',
                    unlocked: false,
                    progress: 32,
                    total: 50,
                    points: 300
                }
            ];
        }

        // ç”Ÿæˆé»˜è®¤æŒ‘æˆ˜æ•°æ®
        function generateDefaultChallenges() {
            return [
                {
                    id: 'daily_story',
                    title: 'æ¯æ—¥æ•…äº‹æŒ‘æˆ˜',
                    description: 'è¿ç»­7å¤©æ¯å¤©åˆ›ä½œä¸€ä¸ªæ•…äº‹',
                    progress: 3,
                    total: 7,
                    reward: 'æ•…äº‹å¤§å¸ˆå¾½ç« ',
                    points: 150,
                    deadline: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 'math_marathon',
                    title: 'æ•°å­¦é©¬æ‹‰æ¾',
                    description: 'å®Œæˆ100é“æ•°å­¦é¢˜ç›®',
                    progress: 45,
                    total: 100,
                    reward: 'è®¡ç®—å°èƒ½æ‰‹ç§°å·',
                    points: 200,
                    deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 'art_gallery',
                    title: 'å®¶åº­ç”»å»Š',
                    description: 'åˆ›ä½œ15å¹…åä½œç”»ä½œ',
                    progress: 8,
                    total: 15,
                    reward: 'è‰ºæœ¯å®¶åº­è®¤è¯',
                    points: 180,
                    deadline: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000)
                }
            ];
        }

        // åŠ è½½å®¶åº­ç­‰çº§
        function loadFamilyLevel() {
            const level = calculateFamilyLevel();
            const currentExp = familyData.totalPoints || 1650;
            const nextLevelExp = level * 400; // æ¯çº§éœ€è¦æ›´å¤šç»éªŒ
            const expForCurrentLevel = (level - 1) * 400;
            const expProgress = currentExp - expForCurrentLevel;
            const expNeeded = nextLevelExp - expForCurrentLevel;
            
            document.getElementById('familyLevel').textContent = `å­¦ä¹ æ–°æ˜Ÿå®¶åº­ Lv.${level}`;
            document.getElementById('pointsToNext').textContent = nextLevelExp - currentExp;
            document.getElementById('currentExp').textContent = currentExp;
            
            // æ›´æ–°è¿›åº¦ç¯
            const progressPercentage = (expProgress / expNeeded) * 100;
            const circumference = 2 * Math.PI * 52;
            const offset = circumference - (progressPercentage / 100) * circumference;
            document.getElementById('levelProgress').style.strokeDashoffset = offset;
        }

        // è®¡ç®—å®¶åº­ç­‰çº§
        function calculateFamilyLevel() {
            const totalPoints = familyData.totalPoints || 1650;
            return Math.floor(totalPoints / 400) + 1;
        }

        // åŠ è½½æˆå°±
        function loadAchievements() {
            loadLatestAchievements();
            loadAchievementGallery();
        }

        // åŠ è½½æœ€æ–°æˆå°±
        function loadLatestAchievements() {
            const latestAchievements = achievements
                .filter(a => a.unlocked)
                .sort((a, b) => new Date(b.unlockedDate) - new Date(a.unlockedDate))
                .slice(0, 3);

            const container = document.getElementById('latestAchievements');
            
            if (latestAchievements.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-3xl mb-2"></i>
                        <p>å¼€å§‹å®¶åº­å­¦ä¹ æ´»åŠ¨æ¥è·å¾—ç¬¬ä¸€ä¸ªæˆå°±å§ï¼</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = latestAchievements.map(achievement => `
                <div class="achievement-card unlocked celebration-animation" onclick="showAchievementDetail('${achievement.id}')">
                    <div class="flex items-center space-x-4">
                        <div class="achievement-badge ${achievement.type}">
                            <i class="${achievement.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-lg">${achievement.title}</h4>
                            <p class="text-gray-600 text-sm mb-2">${achievement.description}</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-calendar mr-1"></i>${formatDate(achievement.unlockedDate)}</span>
                                <span><i class="fas fa-coins mr-1"></i>+${achievement.points}</span>
                                <span><i class="fas fa-users mr-1"></i>${achievement.participants.join(', ')}</span>
                            </div>
                        </div>
                        <div class="text-yellow-500 text-2xl">
                            <i class="fas fa-medal"></i>
                        </div>
                    </div>
                    <div class="sparkle" style="top: 20px; left: 20px; animation-delay: 0s;"></div>
                    <div class="sparkle" style="top: 30px; right: 30px; animation-delay: 0.5s;"></div>
                    <div class="sparkle" style="bottom: 20px; left: 40px; animation-delay: 1s;"></div>
                </div>
            `).join('');
        }

        // åŠ è½½æˆå°±ç”»å»Š
        function loadAchievementGallery() {
            const container = document.getElementById('achievementGallery');
            
            container.innerHTML = achievements.map(achievement => {
                const isUnlocked = achievement.unlocked;
                const progressHtml = !isUnlocked && achievement.progress !== undefined ? 
                    `<div class="mt-3">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>è¿›åº¦</span>
                            <span>${achievement.progress}/${achievement.total}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" 
                                 style="width: ${(achievement.progress / achievement.total) * 100}%"></div>
                        </div>
                    </div>` : '';

                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" 
                         onclick="showAchievementDetail('${achievement.id}')">
                        <div class="text-center">
                            <div class="achievement-badge ${isUnlocked ? achievement.type : 'locked'}">
                                <i class="${achievement.icon}"></i>
                            </div>
                            <h4 class="font-bold text-lg mb-2 ${isUnlocked ? 'text-gray-800' : 'text-gray-500'}">${achievement.title}</h4>
                            <p class="text-sm mb-3 ${isUnlocked ? 'text-gray-600' : 'text-gray-400'}">${achievement.description}</p>
                            <div class="text-xs ${isUnlocked ? 'text-yellow-600' : 'text-gray-400'} font-semibold">
                                <i class="fas fa-coins mr-1"></i>+${achievement.points} ç§¯åˆ†
                            </div>
                            ${progressHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½æŒ‘æˆ˜ä»»åŠ¡
        function loadChallenges() {
            const container = document.getElementById('challengeTasks');
            
            container.innerHTML = challengeTasks.map(challenge => {
                const progressPercentage = (challenge.progress / challenge.total) * 100;
                const daysLeft = Math.ceil((challenge.deadline - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="achievement-card">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-red-400 to-pink-400 flex items-center justify-center text-white">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-gray-800">${challenge.title}</h4>
                                    <span class="text-xs text-red-500 bg-red-100 px-2 py-1 rounded">
                                        ${daysLeft}å¤©åç»“æŸ
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">${challenge.description}</p>
                                <div class="mb-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>è¿›åº¦</span>
                                        <span>${challenge.progress}/${challenge.total}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-gradient-to-r from-red-400 to-pink-400 h-3 rounded-full transition-all duration-500" 
                                             style="width: ${progressPercentage}%"></div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-green-600 font-semibold">${challenge.reward}</span>
                                    <span class="text-yellow-600 font-semibold">+${challenge.points} ç§¯åˆ†</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStatistics() {
            const unlockedCount = achievements.filter(a => a.unlocked).length;
            const totalPoints = familyData.totalPoints || 1650;
            const collaborativeDays = familyData.collaborativeDays || 15;
            const familyRank = familyData.rank || 68;

            document.getElementById('totalAchievements').textContent = unlockedCount;
            document.getElementById('familyPoints').textContent = totalPoints;
            document.getElementById('collaborativeDays').textContent = collaborativeDays;
            document.getElementById('familyRank').textContent = familyRank;

            // æ·»åŠ æ•°å­—åŠ¨ç”»
            animateCounters();
        }

        // æ˜¾ç¤ºæˆå°±è¯¦æƒ…
        function showAchievementDetail(achievementId) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement) return;

            if (!achievement.unlocked) {
                MengyaUtils.Notification.info(`è¿˜æœªè§£é”æ­¤æˆå°±ã€‚è¿›åº¦: ${achievement.progress || 0}/${achievement.total || 1}`);
                return;
            }

            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('modalBadge').className = `achievement-badge ${achievement.type}`;
            document.getElementById('modalBadge').innerHTML = `<i class="${achievement.icon}"></i>`;
            document.getElementById('modalTitle').textContent = achievement.title;
            document.getElementById('modalDescription').textContent = achievement.description;
            document.getElementById('modalDate').textContent = formatDate(achievement.unlockedDate);
            document.getElementById('modalPoints').textContent = `+${achievement.points}`;
            document.getElementById('modalMembers').textContent = achievement.participants.join(', ');

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('achievementModal').classList.remove('hidden');
            document.getElementById('achievementModal').classList.add('flex');
        }

        // å…³é—­æˆå°±è¯¦æƒ…æ¨¡æ€æ¡†
        function closeAchievementModal() {
            document.getElementById('achievementModal').classList.add('hidden');
            document.getElementById('achievementModal').classList.remove('flex');
        }

        // åˆ†äº«æˆå°±
        async function shareAchievements() {
            const shareModal = document.createElement('div');
            shareModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            shareModal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 m-6 max-w-md w-full">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ‰</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">åˆ†äº«å®¶åº­æˆå°±</h3>
                        <p class="text-gray-600 mb-6">é€‰æ‹©åˆ†äº«æ–¹å¼</p>
                        
                        <div class="space-y-3 mb-6">
                            <button onclick="shareToSocial()" class="w-full p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-share-alt text-blue-500"></i>
                                    <div class="text-left">
                                        <div class="font-semibold">åˆ†äº«åˆ°ç¤¾äº¤å¹³å°</div>
                                        <div class="text-sm text-gray-600">è®©æ›´å¤šäººçœ‹åˆ°æˆ‘ä»¬çš„æˆå°±</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="generateAchievementReport()" class="w-full p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-file-alt text-green-500"></i>
                                    <div class="text-left">
                                        <div class="font-semibold">ç”Ÿæˆæˆå°±æŠ¥å‘Š</div>
                                        <div class="text-sm text-gray-600">åˆ›å»ºè¯¦ç»†çš„æˆå°±æ€»ç»“</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="createAchievementVideo()" class="w-full p-4 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-video text-purple-500"></i>
                                    <div class="text-left">
                                        <div class="font-semibold">åˆ¶ä½œæˆå°±è§†é¢‘</div>
                                        <div class="text-sm text-gray-600">ç”Ÿæˆç²¾ç¾çš„æˆå°±å±•ç¤ºè§†é¢‘</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        
                        <button onclick="closeShareModal()" class="w-full py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(shareModal);
            window.currentShareModal = shareModal;
        }

        // åˆ†äº«åˆ°ç¤¾äº¤å¹³å°
        async function shareToSocial() {
            const unlockedCount = achievements.filter(a => a.unlocked).length;
            const totalPoints = familyData.totalPoints || 1650;
            
            const shareText = `ğŸ† æˆ‘ä»¬å®¶åœ¨èŒèŠ½AIå·²ç»è·å¾—äº†${unlockedCount}ä¸ªæˆå°±ï¼Œç´¯è®¡${totalPoints}ç§¯åˆ†ï¼ä¸€èµ·æ¥ä½“éªŒå®¶åº­åä½œå­¦ä¹ çš„ä¹è¶£å§ï¼`;
            
            closeShareModal();
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'å®¶åº­å­¦ä¹ æˆå°±',
                        text: shareText,
                        url: window.location.href
                    });
                } catch (error) {
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿ä½œä¸ºåå¤‡
                    await navigator.clipboard.writeText(shareText);
                    MengyaUtils.Notification.success('æˆå°±ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                await navigator.clipboard.writeText(shareText);
                MengyaUtils.Notification.success('æˆå°±ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
        }

        // ç”Ÿæˆæˆå°±æŠ¥å‘Š
        function generateAchievementReport() {
            closeShareModal();
            
            // æ˜¾ç¤ºç”Ÿæˆä¸­çš„åŠ¨ç”»
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 relative">
                        <div class="absolute inset-0 rounded-full border-4 border-blue-200"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-2xl">
                            ğŸ“Š
                        </div>
                    </div>
                    <p class="text-gray-600">æ­£åœ¨ç”Ÿæˆæˆå°±æŠ¥å‘Š...</p>
                </div>
            `;
            
            document.body.appendChild(loadingModal);
            
            // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
            setTimeout(() => {
                document.body.removeChild(loadingModal);
                
                // åˆ›å»ºæŠ¥å‘Šå†…å®¹
                const unlockedCount = achievements.filter(a => a.unlocked).length;
                const totalPoints = familyData.totalPoints || 1650;
                const reportData = {
                    totalAchievements: unlockedCount,
                    totalPoints: totalPoints,
                    categories: getCategoryStats(),
                    recentAchievements: achievements.filter(a => a.unlocked).slice(0, 5),
                    timestamp: new Date().toISOString()
                };
                
                // ä¸‹è½½æŠ¥å‘Š
                downloadReport(reportData);
                MengyaUtils.Notification.success('ğŸ“Š æˆå°±æŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼');
            }, 3000);
        }

        // è·å–åˆ†ç±»ç»Ÿè®¡
        function getCategoryStats() {
            const categories = {};
            achievements.filter(a => a.unlocked).forEach(achievement => {
                const category = achievement.type;
                if (!categories[category]) {
                    categories[category] = { count: 0, points: 0 };
                }
                categories[category].count++;
                categories[category].points += achievement.points;
            });
            return categories;
        }

        // ä¸‹è½½æŠ¥å‘Š
        function downloadReport(data) {
            const reportContent = `
# å®¶åº­å­¦ä¹ æˆå°±æŠ¥å‘Š

## æ€»ä½“æ¦‚å†µ
- æ€»æˆå°±æ•°: ${data.totalAchievements}
- æ€»ç§¯åˆ†: ${data.totalPoints}
- ç”Ÿæˆæ—¶é—´: ${new Date(data.timestamp).toLocaleString('zh-CN')}

## åˆ†ç±»ç»Ÿè®¡
${Object.entries(data.categories).map(([category, stats]) => 
    `- ${getCategoryDisplayName(category)}: ${stats.count}ä¸ªæˆå°±, ${stats.points}ç§¯åˆ†`
).join('\n')}

## æœ€è¿‘è·å¾—çš„æˆå°±
${data.recentAchievements.map(achievement => 
    `- ${achievement.title}: ${achievement.description} (+${achievement.points}ç§¯åˆ†)`
).join('\n')}
            `;
            
            const blob = new Blob([reportContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family-achievements-${new Date().toISOString().split('T')[0]}.md`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
        function getCategoryDisplayName(category) {
            const names = {
                learning: 'å­¦ä¹ æˆå°±',
                collaboration: 'åä½œæˆå°±',
                creativity: 'åˆ›æ„æˆå°±',
                milestone: 'é‡Œç¨‹ç¢‘',
                special: 'ç‰¹æ®Šæˆå°±'
            };
            return names[category] || category;
        }

        // åˆ¶ä½œæˆå°±è§†é¢‘
        function createAchievementVideo() {
            closeShareModal();
            
            // æ˜¾ç¤ºåˆ¶ä½œä¸­çš„åŠ¨ç”»
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 relative">
                        <div class="absolute inset-0 rounded-full border-4 border-purple-200"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-purple-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-2xl">
                            ğŸ¬
                        </div>
                    </div>
                    <p class="text-gray-600 mb-2">æ­£åœ¨åˆ¶ä½œæˆå°±è§†é¢‘...</p>
                    <div class="text-sm text-gray-500">
                        <div id="videoProgress">æ”¶é›†æˆå°±æ•°æ®...</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loadingModal);
            
            // æ¨¡æ‹Ÿè§†é¢‘åˆ¶ä½œæ­¥éª¤
            const steps = [
                "æ”¶é›†æˆå°±æ•°æ®...",
                "åˆ†æå­¦ä¹ å†ç¨‹...",
                "ç”Ÿæˆè§†è§‰æ•ˆæœ...",
                "æ·»åŠ èƒŒæ™¯éŸ³ä¹...",
                "æ¸²æŸ“æœ€ç»ˆè§†é¢‘..."
            ];
            
            let stepIndex = 0;
            const stepInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    document.getElementById('videoProgress').textContent = steps[stepIndex];
                    stepIndex++;
                } else {
                    clearInterval(stepInterval);
                    document.body.removeChild(loadingModal);
                    MengyaUtils.Notification.success('ğŸ¬ æˆå°±è§†é¢‘åˆ¶ä½œå®Œæˆï¼å·²ä¿å­˜åˆ°ç›¸å†Œã€‚');
                }
            }, 1000);
        }

        // å…³é—­åˆ†äº«æ¨¡æ€æ¡†
        function closeShareModal() {
            if (window.currentShareModal) {
                document.body.removeChild(window.currentShareModal);
                window.currentShareModal = null;
            }
        }

        // è§£é”æ–°æˆå°±ï¼ˆä¾›å…¶ä»–é¡µé¢è°ƒç”¨ï¼‰
        async function unlockAchievement(achievementId, participants = []) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement || achievement.unlocked) return;

            achievement.unlocked = true;
            achievement.unlockedDate = new Date();
            achievement.participants = participants;

            // ä¿å­˜æ•°æ®
            await MengyaUtils.Data.setData('family.achievements', achievements);
            
            // æ›´æ–°å®¶åº­ç§¯åˆ†
            familyData.totalPoints = (familyData.totalPoints || 0) + achievement.points;
            await MengyaUtils.Data.setData('family', familyData);

            // æ˜¾ç¤ºåº†ç¥åŠ¨ç”»
            showAchievementCelebration(achievement);
            
            // é‡æ–°åŠ è½½æ˜¾ç¤º
            loadAchievements();
            updateStatistics();
            loadFamilyLevel();
        }

        // æ˜¾ç¤ºæˆå°±åº†ç¥åŠ¨ç”»
        function showAchievementCelebration(achievement) {
            // åˆ›å»ºåº†ç¥å¼¹çª—
            const celebration = document.createElement('div');
            celebration.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            celebration.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center celebration-animation">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">æ­å–œè§£é”æ–°æˆå°±ï¼</h2>
                    <div class="achievement-badge ${achievement.type} mx-auto mb-4">
                        <i class="${achievement.icon}"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${achievement.title}</h3>
                    <p class="text-gray-600 mb-4">${achievement.description}</p>
                    <div class="text-yellow-600 font-bold text-lg">+${achievement.points} ç§¯åˆ†</div>
                </div>
            `;
            
            document.body.appendChild(celebration);
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                document.body.removeChild(celebration);
            }, 3000);
            
            // æ’­æ”¾åº†ç¥éŸ³æ•ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            try {
                new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+Dyvmg').play();
            } catch (error) {
                // å¿½ç•¥éŸ³æ•ˆæ’­æ”¾é”™è¯¯
            }
        }

        // æ›´æ–°æŒ‘æˆ˜è¿›åº¦
        async function updateChallengeProgress(challengeId, increment = 1) {
            const challenge = challengeTasks.find(c => c.id === challengeId);
            if (!challenge) return;

            challenge.progress = Math.min(challenge.progress + increment, challenge.total);
            
            // ä¿å­˜æ•°æ®
            await MengyaUtils.Data.setData('family.challenges', challengeTasks);
            
            // æ£€æŸ¥æ˜¯å¦å®ŒæˆæŒ‘æˆ˜
            if (challenge.progress >= challenge.total) {
                // å®ŒæˆæŒ‘æˆ˜ï¼Œç»™äºˆå¥–åŠ±
                familyData.totalPoints = (familyData.totalPoints || 0) + challenge.points;
                await MengyaUtils.Data.setData('family', familyData);
                
                MengyaUtils.Notification.success(`ğŸŠ å®ŒæˆæŒ‘æˆ˜ï¼š${challenge.title}ï¼è·å¾— ${challenge.points} ç§¯åˆ†ï¼`);
                
                // ç§»é™¤å·²å®Œæˆçš„æŒ‘æˆ˜
                challengeTasks = challengeTasks.filter(c => c.id !== challengeId);
                await MengyaUtils.Data.setData('family.challenges', challengeTasks);
                
                // é‡æ–°åŠ è½½æ˜¾ç¤º
                loadChallenges();
                updateStatistics();
                loadFamilyLevel();
            } else {
                // é‡æ–°åŠ è½½æŒ‘æˆ˜æ˜¾ç¤º
                loadChallenges();
            }
        }

        // æ•°å­—åŠ¨ç”»
        function animateCounters() {
            const counters = document.querySelectorAll('#totalAchievements, #familyPoints, #collaborativeDays, #familyRank');
            counters.forEach(counter => {
                const target = parseInt(counter.textContent);
                let current = 0;
                const increment = target / 30;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    counter.textContent = Math.floor(current);
                }, 50);
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return new Date(date).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function navigateBack() {
            MengyaUtils.Navigation.smartBack();
        }

        // å¯¼å‡ºå‡½æ•°ä¾›å…¶ä»–é¡µé¢ä½¿ç”¨
        window.FamilyAchievements = {
            unlockAchievement,
            updateChallengeProgress
        };
    </script>
</body>
</html> 