<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº²å­åä½œå­¦ä¹  - èŒèŠ½AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="mengya-common.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .collaboration-container {
            background: white;
            border-radius: 25px 25px 0 0;
            min-height: calc(100vh - 120px);
            position: relative;
        }
        .participant-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 16px;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        .participant-card.active {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .activity-workspace {
            background: #f8fafc;
            border-radius: 20px;
            padding: 24px;
            margin: 16px 0;
            border: 2px dashed #e2e8f0;
            min-height: 300px;
            position: relative;
        }
        .collaboration-tool {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .collaboration-tool:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        .real-time-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .progress-ring {
            width: 80px;
            height: 80px;
            position: relative;
        }
        .progress-ring circle {
            fill: none;
            stroke-width: 6;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .turn-indicator {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            animation: turnGlow 2s ease-in-out infinite;
        }
        @keyframes turnGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="gradient-bg px-6 py-4">
        <div class="flex items-center justify-between">
            <button onclick="navigateBack()" class="text-white text-xl">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="text-center flex-1">
                <h1 class="text-white text-lg font-bold">äº²å­åä½œå­¦ä¹ </h1>
                <p class="text-white text-sm opacity-90" id="activityTitle">é€‰æ‹©åä½œæ´»åŠ¨</p>
            </div>
            <button onclick="showCollaborationSettings()" class="text-white text-xl">
                <i class="fas fa-users-cog"></i>
            </button>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="collaboration-container">
        <!-- å‚ä¸è€…çŠ¶æ€ -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-users mr-2 text-blue-600"></i>
                åä½œå‚ä¸è€…
                <div class="real-time-indicator ml-2"></div>
            </h3>
            <div id="participantsList" class="space-y-3">
                <!-- å‚ä¸è€…å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ´»åŠ¨é€‰æ‹© -->
        <div class="px-6 py-4" id="activitySelector">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-play-circle mr-2 text-green-600"></i>
                é€‰æ‹©åä½œæ´»åŠ¨
            </h3>
            <div class="grid grid-cols-1 gap-4">
                <div class="collaboration-tool" onclick="startCollaborativeActivity('story')">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">åä½œæ•…äº‹åˆ›ä½œ</h4>
                            <p class="text-sm text-gray-600">è½®æµæ¥é¾™ï¼Œå…±åŒåˆ›ä½œç²¾å½©æ•…äº‹</p>
                            <div class="text-xs text-gray-500 mt-1">
                                <span>æ¨è: 2-4äºº</span> â€¢ <span>æ—¶é•¿: 20-30åˆ†é’Ÿ</span>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                    </div>
                </div>

                <div class="collaboration-tool" onclick="startCollaborativeActivity('puzzle')">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-blue-400 to-teal-400 flex items-center justify-center text-white">
                            <i class="fas fa-puzzle-piece"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">æ™ºåŠ›æ‹¼å›¾æŒ‘æˆ˜</h4>
                            <p class="text-sm text-gray-600">å…±åŒè§£å†³é€»è¾‘è°œé¢˜å’Œæ‹¼å›¾æ¸¸æˆ</p>
                            <div class="text-xs text-gray-500 mt-1">
                                <span>æ¨è: 2-3äºº</span> â€¢ <span>æ—¶é•¿: 15-25åˆ†é’Ÿ</span>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                    </div>
                </div>

                <div class="collaboration-tool" onclick="startCollaborativeActivity('drawing')">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white">
                            <i class="fas fa-palette"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">åä½œç»˜ç”»åˆ›ä½œ</h4>
                            <p class="text-sm text-gray-600">ä¸€èµ·ç”»ç”»ï¼Œå‘æŒ¥åˆ›æ„æƒ³è±¡åŠ›</p>
                            <div class="text-xs text-gray-500 mt-1">
                                <span>æ¨è: 2-4äºº</span> â€¢ <span>æ—¶é•¿: 25-35åˆ†é’Ÿ</span>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                    </div>
                </div>

                <div class="collaboration-tool" onclick="startCollaborativeActivity('quiz')">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-green-400 to-blue-400 flex items-center justify-center text-white">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">çŸ¥è¯†é—®ç­”æ¯”èµ›</h4>
                            <p class="text-sm text-gray-600">è½®æµå‡ºé¢˜ç­”é¢˜ï¼Œå¢é•¿çŸ¥è¯†</p>
                            <div class="text-xs text-gray-500 mt-1">
                                <span>æ¨è: 2-4äºº</span> â€¢ <span>æ—¶é•¿: 20-30åˆ†é’Ÿ</span>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- åä½œå·¥ä½œåŒº -->
        <div class="px-6 py-4 hidden" id="collaborationWorkspace">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-cogs mr-2 text-purple-600"></i>
                    åä½œè¿›è¡Œä¸­
                </h3>
                <button onclick="endCollaboration()" class="text-red-500 hover:text-red-600">
                    <i class="fas fa-stop-circle text-xl"></i>
                </button>
            </div>

            <!-- å½“å‰è½®æ¬¡æŒ‡ç¤ºå™¨ -->
            <div class="text-center mb-6" id="turnIndicator">
                <div class="turn-indicator inline-block">
                    <i class="fas fa-user mr-2"></i>
                    è½®åˆ° <span id="currentPlayer">å°æ˜</span> äº†
                </div>
            </div>

            <!-- æ´»åŠ¨å·¥ä½œåŒº -->
            <div class="activity-workspace" id="workspaceContent">
                <!-- å…·ä½“æ´»åŠ¨å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- åä½œå·¥å…·æ  -->
            <div class="flex justify-center space-x-4 mt-6" id="collaborationTools">
                <button onclick="nextTurn()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-600 transition-colors">
                    <i class="fas fa-forward mr-2"></i>ä¸‹ä¸€ä½
                </button>
                <button onclick="pauseCollaboration()" class="bg-gray-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-gray-600 transition-colors">
                    <i class="fas fa-pause mr-2"></i>æš‚åœ
                </button>
                <button onclick="saveProgress()" class="bg-green-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-600 transition-colors">
                    <i class="fas fa-save mr-2"></i>ä¿å­˜
                </button>
            </div>
        </div>

        <!-- åä½œå†å² -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-history mr-2 text-indigo-600"></i>
                åä½œå†å²
            </h3>
            <div id="collaborationHistory" class="space-y-3">
                <!-- å†å²è®°å½•å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        let currentActivity = null;
        let participants = [];
        let currentPlayerIndex = 0;
        let collaborationData = {};

        // é¡µé¢åˆå§‹åŒ–
        MengyaUtils.Lifecycle.onInit(async () => {
            await initializeCollaboration();
            loadParticipants();
            loadCollaborationHistory();
        });

        // åˆå§‹åŒ–åä½œå­¦ä¹ 
        async function initializeCollaboration() {
            try {
                // è·å–å®¶åº­æˆå‘˜ä¿¡æ¯
                const familyData = await MengyaUtils.Data.getData('family') || {};
                participants = familyData.members || [
                    { id: 'parent1', name: 'çˆ¸çˆ¸', avatar: 'ğŸ‘¨', role: 'parent', status: 'ready' },
                    { id: 'child1', name: 'å°æ˜', avatar: 'ğŸ‘¦', role: 'child', status: 'ready' }
                ];

                // åä½œå­¦ä¹ åˆå§‹åŒ–å®Œæˆ
            } catch (error) {
                console.error('åä½œå­¦ä¹ åˆå§‹åŒ–å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤å‚ä¸è€…
                participants = [
                    { id: 'parent1', name: 'çˆ¸çˆ¸', avatar: 'ğŸ‘¨', role: 'parent', status: 'ready' },
                    { id: 'child1', name: 'å°æ˜', avatar: 'ğŸ‘¦', role: 'child', status: 'ready' }
                ];
            }
        }

        // åŠ è½½å‚ä¸è€…åˆ—è¡¨
        function loadParticipants() {
            const container = document.getElementById('participantsList');
            
            container.innerHTML = participants.map(participant => {
                const statusColors = {
                    ready: 'text-green-500 bg-green-100',
                    active: 'text-blue-500 bg-blue-100',
                    waiting: 'text-yellow-500 bg-yellow-100',
                    offline: 'text-gray-500 bg-gray-100'
                };

                const statusTexts = {
                    ready: 'å‡†å¤‡å°±ç»ª',
                    active: 'æ­£åœ¨å‚ä¸',
                    waiting: 'ç­‰å¾…ä¸­',
                    offline: 'ç¦»çº¿'
                };

                return `
                    <div class="participant-card ${participant.status === 'active' ? 'active' : ''}" id="participant-${participant.id}">
                        <div class="flex items-center space-x-4">
                            <div class="text-3xl">${participant.avatar}</div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h4 class="font-semibold text-gray-800">${participant.name}</h4>
                                    <span class="text-xs ${statusColors[participant.status]} px-2 py-1 rounded-full">
                                        ${statusTexts[participant.status]}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600">${getRoleDescription(participant.role)}</p>
                            </div>
                            <div class="real-time-indicator"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // è·å–è§’è‰²æè¿°
        function getRoleDescription(role) {
            const descriptions = {
                parent: 'å®¶é•¿ - å¼•å¯¼å’ŒååŠ©',
                child: 'å­©å­ - ä¸»è¦å­¦ä¹ è€…'
            };
            return descriptions[role] || 'å‚ä¸è€…';
        }

        // å¼€å§‹åä½œæ´»åŠ¨
        function startCollaborativeActivity(activityType) {
            currentActivity = activityType;
            
            // éšè—é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºå·¥ä½œåŒº
            document.getElementById('activitySelector').classList.add('hidden');
            document.getElementById('collaborationWorkspace').classList.remove('hidden');
            
            // æ›´æ–°æ ‡é¢˜
            const titles = {
                story: 'åä½œæ•…äº‹åˆ›ä½œ',
                puzzle: 'æ™ºåŠ›æ‹¼å›¾æŒ‘æˆ˜',
                drawing: 'åä½œç»˜ç”»åˆ›ä½œ',
                quiz: 'çŸ¥è¯†é—®ç­”æ¯”èµ›'
            };
            document.getElementById('activityTitle').textContent = titles[activityType];
            
            // è®¾ç½®å‚ä¸è€…çŠ¶æ€
            participants.forEach((participant, index) => {
                participant.status = index === 0 ? 'active' : 'waiting';
            });
            loadParticipants();
            
            // åˆå§‹åŒ–å·¥ä½œåŒº
            initializeWorkspace(activityType);
            
            // è®¾ç½®å½“å‰ç©å®¶
            currentPlayerIndex = 0;
            updateCurrentPlayer();
            
            MengyaUtils.Notification.success(`${titles[activityType]}å¼€å§‹ï¼`);
        }

        // åˆå§‹åŒ–å·¥ä½œåŒº
        function initializeWorkspace(activityType) {
            const workspace = document.getElementById('workspaceContent');
            
            switch (activityType) {
                case 'story':
                    workspace.innerHTML = `
                        <div class="text-center mb-6">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">æˆ‘ä»¬çš„æ•…äº‹</h4>
                            <p class="text-gray-600">æ¯äººè½®æµæ·»åŠ ä¸€å¥è¯ï¼Œåˆ›ä½œå±äºæˆ‘ä»¬çš„æ•…äº‹</p>
                        </div>
                        <div id="storyContent" class="bg-white rounded-lg p-6 min-h-40 mb-4 border-2 border-dashed border-gray-200">
                            <p class="text-gray-400 text-center">æ•…äº‹å³å°†å¼€å§‹...</p>
                        </div>
                        <div class="flex space-x-4">
                            <input type="text" id="storyInput" placeholder="æ·»åŠ ä½ çš„æ•…äº‹å†…å®¹..." 
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="addStoryLine()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                æ·»åŠ 
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'puzzle':
                    workspace.innerHTML = `
                        <div class="text-center mb-6">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">æ™ºåŠ›æ‹¼å›¾æŒ‘æˆ˜</h4>
                            <p class="text-gray-600">åˆä½œè§£å†³æ‹¼å›¾ï¼Œé”»ç‚¼é€»è¾‘æ€ç»´</p>
                        </div>
                        <div id="puzzleArea" class="bg-white rounded-lg p-6 min-h-60 mb-4 border-2 border-dashed border-gray-200">
                            <div class="grid grid-cols-3 gap-2 max-w-xs mx-auto">
                                ${generatePuzzlePieces()}
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-4">ç§»åŠ¨æ‹¼å›¾å—åˆ°æ­£ç¡®ä½ç½®</p>
                            <button onclick="resetPuzzle()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                é‡ç½®æ‹¼å›¾
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'drawing':
                    workspace.innerHTML = `
                        <div class="text-center mb-6">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">åä½œç»˜ç”»åˆ›ä½œ</h4>
                            <p class="text-gray-600">ä¸€èµ·åˆ›ä½œç¾ä¸½çš„ç”»ä½œ</p>
                        </div>
                        <div id="drawingCanvas" class="bg-white rounded-lg p-4 mb-4 border-2 border-dashed border-gray-200">
                            <canvas width="300" height="200" class="border border-gray-300 mx-auto block"></canvas>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button onclick="clearCanvas()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                æ¸…é™¤ç”»å¸ƒ
                            </button>
                            <button onclick="saveDrawing()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                ä¿å­˜ä½œå“
                            </button>
                        </div>
                    `;
                    initializeDrawingCanvas();
                    break;
                    
                case 'quiz':
                    workspace.innerHTML = `
                        <div class="text-center mb-6">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">çŸ¥è¯†é—®ç­”æ¯”èµ›</h4>
                            <p class="text-gray-600">è½®æµå‡ºé¢˜å’Œç­”é¢˜ï¼Œå¢é•¿çŸ¥è¯†</p>
                        </div>
                        
                        <!-- æ¨¡å¼é€‰æ‹© -->
                        <div class="flex space-x-3 mb-4" id="quizModeSelector">
                            <button onclick="setQuizMode('manual')" class="quiz-mode-btn active flex-1 py-3 bg-blue-500 text-white rounded-lg font-semibold">
                                è‡ªç”±é—®ç­”
                            </button>
                            <button onclick="setQuizMode('math')" class="quiz-mode-btn flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold">
                                æ•°å­¦æŒ‘æˆ˜
                            </button>
                        </div>
                        
                        <div id="quizContent" class="bg-white rounded-lg p-6 min-h-40 mb-4">
                            <div class="text-center text-gray-400">
                                <i class="fas fa-question-circle text-4xl mb-4"></i>
                                <p>å‡†å¤‡ç¬¬ä¸€ä¸ªé—®é¢˜...</p>
                            </div>
                        </div>
                        
                        <!-- æ‰‹åŠ¨é—®ç­”æ¨¡å¼ -->
                        <div class="space-y-4" id="manualQuizInput">
                            <input type="text" id="questionInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="answerInput" placeholder="è¾“å…¥æ­£ç¡®ç­”æ¡ˆ..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="submitQuestion()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                                æäº¤é—®é¢˜
                            </button>
                        </div>
                        
                        <!-- æ•°å­¦æŒ‘æˆ˜æ¨¡å¼ -->
                        <div class="space-y-4 hidden" id="mathQuizControls">
                            <div class="flex space-x-3">
                                <button onclick="generateMathProblem()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
                                    <i class="fas fa-dice mr-2"></i>ç”Ÿæˆæ•°å­¦é¢˜
                                </button>
                                <button onclick="increaseMathLevel()" class="bg-yellow-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-yellow-600">
                                    éš¾åº¦ <span id="mathLevelDisplay">1</span>
                                </button>
                            </div>
                            <div class="text-center">
                                <span class="text-sm text-gray-600">å¾—åˆ†: </span>
                                <span id="mathScoreDisplay" class="font-bold text-blue-600">0</span>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // ç”Ÿæˆæ‹¼å›¾å—
        function generatePuzzlePieces() {
            const pieces = Array.from({length: 9}, (_, i) => i + 1);
            const shuffled = pieces.sort(() => Math.random() - 0.5);
            
            return shuffled.map((piece, index) => `
                <div class="puzzle-piece bg-blue-${piece}00 h-20 rounded-lg flex items-center justify-center text-white font-bold text-xl cursor-pointer hover:scale-105 transition-transform"
                     onclick="movePuzzlePiece(${index})" data-piece="${piece}">
                    ${piece}
                </div>
            `).join('');
        }

        // åˆå§‹åŒ–ç»˜ç”»ç”»å¸ƒ
        function initializeDrawingCanvas() {
            const canvas = document.querySelector('#drawingCanvas canvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                ctx.beginPath();
                ctx.moveTo(e.offsetX, e.offsetY);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDrawing) {
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });

            // è®¾ç½®ç”»ç¬”æ ·å¼
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
        }

        // æ·»åŠ æ•…äº‹å†…å®¹
        function addStoryLine() {
            const input = document.getElementById('storyInput');
            const content = input.value.trim();
            
            if (content) {
                const storyContent = document.getElementById('storyContent');
                const currentPlayer = participants[currentPlayerIndex];
                
                const storyLine = document.createElement('div');
                storyLine.className = 'mb-3 p-3 bg-gray-50 rounded-lg';
                storyLine.innerHTML = `
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="text-sm">${currentPlayer.avatar}</span>
                        <span class="text-sm font-semibold text-gray-700">${currentPlayer.name}:</span>
                    </div>
                    <p class="text-gray-800">${content}</p>
                `;
                
                storyContent.appendChild(storyLine);
                input.value = '';
                
                // å¦‚æœæ˜¯ç¬¬ä¸€å¥è¯ï¼Œæ¸…é™¤å ä½æ–‡æœ¬
                const placeholder = storyContent.querySelector('.text-gray-400');
                if (placeholder) {
                    placeholder.remove();
                }
                
                nextTurn();
            }
        }

        // ä¸‹ä¸€è½®
        function nextTurn() {
            currentPlayerIndex = (currentPlayerIndex + 1) % participants.length;
            updateCurrentPlayer();
            updateParticipantStatus();
        }

        // æ›´æ–°å½“å‰ç©å®¶
        function updateCurrentPlayer() {
            const currentPlayer = participants[currentPlayerIndex];
            document.getElementById('currentPlayer').textContent = currentPlayer.name;
        }

        // æ›´æ–°å‚ä¸è€…çŠ¶æ€
        function updateParticipantStatus() {
            participants.forEach((participant, index) => {
                participant.status = index === currentPlayerIndex ? 'active' : 'waiting';
            });
            loadParticipants();
        }

        // æš‚åœåä½œ
        function pauseCollaboration() {
            MengyaUtils.Notification.info('åä½œå·²æš‚åœ');
        }

        // ä¿å­˜è¿›åº¦
        async function saveProgress() {
            try {
                const progressData = {
                    activity: currentActivity,
                    participants: participants,
                    timestamp: new Date(),
                    content: getActivityContent()
                };
                
                await MengyaUtils.Data.setData('collaboration.currentProgress', progressData);
                MengyaUtils.Notification.success('è¿›åº¦å·²ä¿å­˜ï¼');
            } catch (error) {
                console.error('ä¿å­˜è¿›åº¦å¤±è´¥:', error);
                MengyaUtils.Notification.error('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è·å–æ´»åŠ¨å†…å®¹
        function getActivityContent() {
            switch (currentActivity) {
                case 'story':
                    const storyLines = document.querySelectorAll('#storyContent .mb-3');
                    return Array.from(storyLines).map(line => line.textContent.trim());
                case 'drawing':
                    const canvas = document.querySelector('#drawingCanvas canvas');
                    return canvas.toDataURL();
                default:
                    return null;
            }
        }

        // ç»“æŸåä½œ
        function endCollaboration() {
            if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰åä½œå—ï¼Ÿ')) {
                saveCollaborationRecord();
                
                // é‡ç½®çŠ¶æ€
                currentActivity = null;
                currentPlayerIndex = 0;
                participants.forEach(p => p.status = 'ready');
                
                // æ˜¾ç¤ºé€‰æ‹©å™¨ï¼Œéšè—å·¥ä½œåŒº
                document.getElementById('activitySelector').classList.remove('hidden');
                document.getElementById('collaborationWorkspace').classList.add('hidden');
                document.getElementById('activityTitle').textContent = 'é€‰æ‹©åä½œæ´»åŠ¨';
                
                loadParticipants();
                MengyaUtils.Notification.success('åä½œå·²ç»“æŸï¼');
            }
        }

        // ä¿å­˜åä½œè®°å½•
        async function saveCollaborationRecord() {
            try {
                const record = {
                    id: Date.now(),
                    activity: currentActivity,
                    participants: participants.map(p => p.name),
                    duration: Math.floor(Math.random() * 30) + 15, // æ¨¡æ‹Ÿæ—¶é•¿
                    timestamp: new Date(),
                    content: getActivityContent()
                };

                const history = await MengyaUtils.Data.getData('collaboration.history') || [];
                history.unshift(record);
                
                await MengyaUtils.Data.setData('collaboration.history', history.slice(0, 10));
                loadCollaborationHistory();
            } catch (error) {
                console.error('ä¿å­˜åä½œè®°å½•å¤±è´¥:', error);
            }
        }

        // åŠ è½½åä½œå†å²
        async function loadCollaborationHistory() {
            try {
                const history = await MengyaUtils.Data.getData('collaboration.history') || [];
                const container = document.getElementById('collaborationHistory');
                
                if (history.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-history text-3xl mb-2"></i>
                            <p>è¿˜æ²¡æœ‰åä½œè®°å½•ï¼Œå¼€å§‹ç¬¬ä¸€æ¬¡åä½œå§ï¼</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = history.map(record => {
                    const activityNames = {
                        story: 'æ•…äº‹åˆ›ä½œ',
                        puzzle: 'æ™ºåŠ›æ‹¼å›¾',
                        drawing: 'ç»˜ç”»åˆ›ä½œ',
                        quiz: 'çŸ¥è¯†é—®ç­”'
                    };

                    return `
                        <div class="collaboration-tool" onclick="viewCollaborationRecord('${record.id}')">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-400 to-blue-400 flex items-center justify-center text-white">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-semibold text-gray-800">${activityNames[record.activity]}</span>
                                        <span class="text-xs text-gray-500">${formatTimeAgo(record.timestamp)}</span>
                                    </div>
                                    <p class="text-sm text-gray-600">
                                        ${record.participants.join(' & ')} â€¢ ${record.duration}åˆ†é’Ÿ
                                    </p>
                                </div>
                                <i class="fas fa-eye text-gray-400"></i>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½åä½œå†å²å¤±è´¥:', error);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInHours = Math.floor((now - time) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'åˆšåˆš';
            if (diffInHours < 24) return `${diffInHours}å°æ—¶å‰`;
            return `${Math.floor(diffInHours / 24)}å¤©å‰`;
        }

        // æŸ¥çœ‹åä½œè®°å½•
        function viewCollaborationRecord(recordId) {
            MengyaUtils.Notification.info('æ­£åœ¨åŠ è½½åä½œè®°å½•...');
        }

        // æ˜¾ç¤ºåä½œè®¾ç½®
        function showCollaborationSettings() {
            MengyaUtils.Notification.info('åä½œè®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function navigateBack() {
            if (currentActivity) {
                if (confirm('å½“å‰æœ‰æ­£åœ¨è¿›è¡Œçš„åä½œï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ')) {
                    MengyaUtils.Navigation.smartBack();
                }
            } else {
                MengyaUtils.Navigation.smartBack();
            }
        }

        // æ‹¼å›¾ç›¸å…³å‡½æ•°
        function movePuzzlePiece(index) {
            if (!window.puzzleState) {
                window.puzzleState = {
                    pieces: Array.from({length: 9}, (_, i) => i + 1).sort(() => Math.random() - 0.5),
                    solved: false,
                    moves: 0
                };
            }

            // ç®€åŒ–ç‰ˆæ‹¼å›¾é€»è¾‘ï¼šç‚¹å‡»äº¤æ¢ç›¸é‚»ç‰‡æ®µ
            const pieces = window.puzzleState.pieces;
            const emptyIndex = pieces.indexOf(9); // å‡è®¾9æ˜¯ç©ºä½ç½®
            
            // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
            const canMove = checkAdjacent(index, emptyIndex);
            if (canMove) {
                // äº¤æ¢ä½ç½®
                [pieces[index], pieces[emptyIndex]] = [pieces[emptyIndex], pieces[index]];
                window.puzzleState.moves++;
                
                // æ›´æ–°æ˜¾ç¤º
                updatePuzzleDisplay();
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                if (checkPuzzleSolved()) {
                    setTimeout(() => {
                        MengyaUtils.Notification.success(`ğŸ‰ æ‹¼å›¾å®Œæˆï¼ç”¨äº†${window.puzzleState.moves}æ­¥ï¼`);
                        nextTurn();
                    }, 500);
                }
            } else {
                MengyaUtils.Notification.warning('åªèƒ½ç§»åŠ¨ç›¸é‚»çš„æ‹¼å›¾å—ï¼');
            }
        }

        function checkAdjacent(index1, index2) {
            const row1 = Math.floor(index1 / 3);
            const col1 = index1 % 3;
            const row2 = Math.floor(index2 / 3);
            const col2 = index2 % 3;
            
            return Math.abs(row1 - row2) + Math.abs(col1 - col2) === 1;
        }

        function updatePuzzleDisplay() {
            const container = document.querySelector('#puzzleArea .grid');
            container.innerHTML = window.puzzleState.pieces.map((piece, index) => 
                piece === 9 ? 
                `<div class="puzzle-piece bg-gray-200 h-20 rounded-lg flex items-center justify-center text-gray-400 text-xl">
                    <i class="fas fa-plus"></i>
                </div>` :
                `<div class="puzzle-piece bg-blue-${piece}00 h-20 rounded-lg flex items-center justify-center text-white font-bold text-xl cursor-pointer hover:scale-105 transition-transform"
                     onclick="movePuzzlePiece(${index})" data-piece="${piece}">
                    ${piece}
                </div>`
            ).join('');
        }

        function checkPuzzleSolved() {
            const pieces = window.puzzleState.pieces;
            for (let i = 0; i < 8; i++) {
                if (pieces[i] !== i + 1) return false;
            }
            return pieces[8] === 9; // ç©ºä½åœ¨æœ€å
        }

        function resetPuzzle() {
            window.puzzleState = {
                pieces: Array.from({length: 9}, (_, i) => i + 1).sort(() => Math.random() - 0.5),
                solved: false,
                moves: 0
            };
            updatePuzzleDisplay();
            MengyaUtils.Notification.info('æ‹¼å›¾å·²é‡ç½®ï¼');
        }

        // ç»˜ç”»ç›¸å…³å‡½æ•°
        function clearCanvas() {
            const canvas = document.querySelector('#drawingCanvas canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveDrawing() {
            const canvas = document.querySelector('#drawingCanvas canvas');
            const dataURL = canvas.toDataURL();
            MengyaUtils.Notification.success('ç»˜ç”»ä½œå“å·²ä¿å­˜ï¼');
        }

        // é—®ç­”ç›¸å…³å‡½æ•°
        function submitQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            const answer = document.getElementById('answerInput').value.trim();
            
            if (question && answer) {
                const quizContent = document.getElementById('quizContent');
                const currentPlayer = participants[currentPlayerIndex];
                
                quizContent.innerHTML = `
                    <div class="text-center mb-4">
                        <span class="text-lg">${currentPlayer.avatar}</span>
                        <span class="font-semibold text-gray-700 ml-2">${currentPlayer.name} çš„é—®é¢˜:</span>
                    </div>
                    <div class="text-xl font-semibold text-gray-800 mb-6 text-center">
                        ${question}
                    </div>
                    <div class="text-center">
                        <button onclick="showAnswer('${answer}')" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">
                            æ˜¾ç¤ºç­”æ¡ˆ
                        </button>
                    </div>
                `;
                
                document.getElementById('questionInput').value = '';
                document.getElementById('answerInput').value = '';
                
                nextTurn();
            }
        }

        function showAnswer(answer) {
            MengyaUtils.Notification.success(`æ­£ç¡®ç­”æ¡ˆæ˜¯: ${answer}`);
        }

        // é—®ç­”æ¨¡å¼åˆ‡æ¢
        function setQuizMode(mode) {
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = document.querySelectorAll('.quiz-mode-btn');
            buttons.forEach(btn => {
                btn.className = 'quiz-mode-btn flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold';
            });
            
            event.target.className = 'quiz-mode-btn active flex-1 py-3 bg-blue-500 text-white rounded-lg font-semibold';
            
            // åˆ‡æ¢è¾“å…¥ç•Œé¢
            if (mode === 'manual') {
                document.getElementById('manualQuizInput').classList.remove('hidden');
                document.getElementById('mathQuizControls').classList.add('hidden');
                
                // é‡ç½®å†…å®¹åŒº
                document.getElementById('quizContent').innerHTML = `
                    <div class="text-center text-gray-400">
                        <i class="fas fa-question-circle text-4xl mb-4"></i>
                        <p>å‡†å¤‡ç¬¬ä¸€ä¸ªé—®é¢˜...</p>
                    </div>
                `;
            } else if (mode === 'math') {
                document.getElementById('manualQuizInput').classList.add('hidden');
                document.getElementById('mathQuizControls').classList.remove('hidden');
                
                // åˆå§‹åŒ–æ•°å­¦æŒ‘æˆ˜çŠ¶æ€
                if (!window.mathState) {
                    window.mathState = {
                        currentProblem: null,
                        score: 0,
                        totalQuestions: 0,
                        level: 1
                    };
                }
                
                updateMathDisplay();
            }
        }

        // æ•°å­¦æŒ‘æˆ˜ç›¸å…³å‡½æ•°
        function generateMathProblem() {
            if (!window.mathState) {
                window.mathState = {
                    currentProblem: null,
                    score: 0,
                    totalQuestions: 0,
                    level: 1
                };
            }

            // æ ¹æ®ç­‰çº§ç”Ÿæˆä¸åŒéš¾åº¦çš„é¢˜ç›®
            const level = window.mathState.level;
            let problem;
            
            if (level === 1) {
                // ç®€å•åŠ å‡æ³•
                const a = Math.floor(Math.random() * 10) + 1;
                const b = Math.floor(Math.random() * 10) + 1;
                const operation = Math.random() > 0.5 ? '+' : '-';
                
                if (operation === '+') {
                    problem = {
                        question: `${a} + ${b} = ?`,
                        answer: a + b,
                        options: generateMathOptions(a + b)
                    };
                } else {
                    const larger = Math.max(a, b);
                    const smaller = Math.min(a, b);
                    problem = {
                        question: `${larger} - ${smaller} = ?`,
                        answer: larger - smaller,
                        options: generateMathOptions(larger - smaller)
                    };
                }
            } else if (level === 2) {
                // ä¹˜æ³•
                const a = Math.floor(Math.random() * 9) + 1;
                const b = Math.floor(Math.random() * 9) + 1;
                problem = {
                    question: `${a} Ã— ${b} = ?`,
                    answer: a * b,
                    options: generateMathOptions(a * b)
                };
            } else {
                // æ··åˆè¿ç®—
                const a = Math.floor(Math.random() * 10) + 1;
                const b = Math.floor(Math.random() * 10) + 1;
                const c = Math.floor(Math.random() * 5) + 1;
                problem = {
                    question: `${a} + ${b} Ã— ${c} = ?`,
                    answer: a + (b * c),
                    options: generateMathOptions(a + (b * c))
                };
            }

            window.mathState.currentProblem = problem;
            window.mathState.totalQuestions++;

            // æ›´æ–°æ˜¾ç¤º
            updateMathQuizDisplay(problem);
        }

        function generateMathOptions(correctAnswer) {
            const options = [correctAnswer];
            
            // ç”Ÿæˆ3ä¸ªé”™è¯¯é€‰é¡¹
            while (options.length < 4) {
                const wrongAnswer = correctAnswer + Math.floor(Math.random() * 20) - 10;
                if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
                    options.push(wrongAnswer);
                }
            }
            
            // éšæœºæ’åº
            return options.sort(() => Math.random() - 0.5);
        }

        function updateMathQuizDisplay(problem) {
            const container = document.getElementById('quizContent');
            container.innerHTML = `
                <div class="text-center mb-6">
                    <div class="inline-block bg-green-500 text-white px-4 py-2 rounded-full mb-4">
                        ç­‰çº§ ${window.mathState.level} | ç¬¬ ${window.mathState.totalQuestions} é¢˜
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">${problem.question}</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    ${problem.options.map((option, index) => `
                        <button onclick="selectMathAnswer(${option})" class="math-option bg-white border-2 border-gray-200 rounded-lg p-4 text-xl font-bold hover:border-green-400 hover:bg-green-50 transition-colors">
                            ${option}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        function selectMathAnswer(selectedAnswer) {
            const problem = window.mathState.currentProblem;
            const isCorrect = selectedAnswer === problem.answer;
            
            // æ›´æ–°é€‰é¡¹æ ·å¼
            const options = document.querySelectorAll('.math-option');
            options.forEach(option => {
                const value = parseInt(option.textContent);
                if (value === problem.answer) {
                    option.className = 'math-option bg-green-100 border-2 border-green-400 rounded-lg p-4 text-xl font-bold';
                } else if (value === selectedAnswer && !isCorrect) {
                    option.className = 'math-option bg-red-100 border-2 border-red-400 rounded-lg p-4 text-xl font-bold';
                } else {
                    option.className = 'math-option bg-gray-100 border-2 border-gray-300 rounded-lg p-4 text-xl font-bold';
                }
                option.onclick = null; // ç¦ç”¨ç‚¹å‡»
            });
            
            // æ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                if (isCorrect) {
                    window.mathState.score += window.mathState.level * 10;
                    updateMathDisplay();
                    MengyaUtils.Notification.success(`ç­”å¯¹äº†ï¼+${window.mathState.level * 10}åˆ†`);
                    
                    // æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨å‡çº§
                    if (window.mathState.score >= window.mathState.level * 50) {
                        increaseMathLevel();
                    }
                } else {
                    MengyaUtils.Notification.error(`ç­”é”™äº†ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${problem.answer}`);
                }
                
                // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä½
                setTimeout(() => {
                    nextTurn();
                }, 1500);
            }, 1000);
        }

        function increaseMathLevel() {
            if (window.mathState.level < 3) {
                window.mathState.level++;
                updateMathDisplay();
                MengyaUtils.Notification.success(`æ­å–œå‡çº§åˆ°ç­‰çº§ ${window.mathState.level}ï¼`);
            } else {
                MengyaUtils.Notification.info('å·²ç»æ˜¯æœ€é«˜ç­‰çº§äº†ï¼');
            }
        }

        function updateMathDisplay() {
            const levelDisplay = document.getElementById('mathLevelDisplay');
            const scoreDisplay = document.getElementById('mathScoreDisplay');
            
            if (levelDisplay) levelDisplay.textContent = window.mathState?.level || 1;
            if (scoreDisplay) scoreDisplay.textContent = window.mathState?.score || 0;
        }

    </script>
</body>
</html> 